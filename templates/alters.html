{% extends "base.html" %}

{% block content %}
<style>
    .alerts-header {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .alerts-header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
    }
    
    .alerts-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .alert-stat {
        background: var(--card-bg);
        border-radius: 18px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
    }
    
    .alert-stat h3 {
        font-size: 0.85em;
        color: var(--text-light);
        margin-bottom: 10px;
        text-transform: uppercase;
    }
    
    .alert-stat .value {
        font-size: 2em;
        font-weight: 700;
    }
    
    .critical .value {color: #e53e3e;}
    .warning .value {color: #ed8936;}
    .normal .value {color: #48bb78;}
    
    .alerts-container {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
    }
    
    .alerts-container h2 {
        font-size: 1.5em;
        margin-bottom: 25px;
    }
    
    .alert-item {
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
        gap: 15px;
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from {opacity: 0; transform: translateX(-20px);}
        to {opacity: 1; transform: translateX(0);}
    }
    
    .alert-critical {
        background: #fff5f5;
        border-left: 5px solid #f56565;
    }
    
    .alert-warning {
        background: #fffaf0;
        border-left: 5px solid #ed8936;
    }
    
    .alert-icon {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3em;
    }
    
    .alert-critical .alert-icon {
        background: #fed7d7;
        color: #c53030;
    }
    
    .alert-warning .alert-icon {
        background: #feebc8;
        color: #c05621;
    }
    
    .alert-content {
        flex: 1;
    }
    
    .alert-content h4 {
        font-size: 1.1em;
        color: var(--text);
        margin-bottom: 8px;
    }
    
    .alert-content p {
        font-size: 0.9em;
        color: var(--text-light);
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #a0aec0;
    }
    
    .empty-state i {
        font-size: 4em;
        margin-bottom: 20px;
    }
</style>

<div class="alerts-header">
    <h1><i class="fas fa-bell"></i> Alerts & Notifications</h1>
    <p style="color: var(--text-light);">Real-time energy consumption alerts</p>
</div>

<div class="alerts-stats">
    <div class="alert-stat critical">
        <h3><i class="fas fa-exclamation-triangle"></i> Critical</h3>
        <div class="value" id="critical-count">0</div>
    </div>
    
    <div class="alert-stat warning">
        <h3><i class="fas fa-exclamation-circle"></i> Warning</h3>
        <div class="value" id="warning-count">0</div>
    </div>
    
    <div class="alert-stat normal">
        <h3><i class="fas fa-check-circle"></i> Total</h3>
        <div class="value" id="total-count">0</div>
    </div>
</div>

<div class="alerts-container">
    <h2><i class="fas fa-list"></i> Alert History</h2>
    <div id="alerts-list">
        <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading alerts...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadAlerts() {
        try {
            const response = await fetch('/get-alerts');
            const data = await response.json();
            
            const criticalCount = data.alerts.filter(a => a.severity === 'critical').length;
            const warningCount = data.alerts.filter(a => a.severity === 'warning').length;
            
            document.getElementById('critical-count').textContent = criticalCount;
            document.getElementById('warning-count').textContent = warningCount;
            document.getElementById('total-count').textContent = data.alerts.length;
            
            const alertsList = document.getElementById('alerts-list');
            
            if(data.alerts.length === 0) {
                alertsList.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><h3>No Alerts</h3><p>All systems normal</p></div>';
                return;
            }
            
            alertsList.innerHTML = '';
            data.alerts.slice().reverse().forEach(alert => {
                const alertClass = alert.severity === 'critical' ? 'alert-critical' : 'alert-warning';
                const alertIcon = alert.severity === 'critical' ? 'fa-exclamation-triangle' : 'fa-exclamation-circle';
                const costImpact = alert.estimated_cost ? '<p style="margin-top: 5px;"><i class="fas fa-dollar-sign"></i> Cost Impact: <strong>$' + alert.estimated_cost.toFixed(2) + '/hour</strong></p>' : '';
                
                alertsList.innerHTML += '<div class="alert-item ' + alertClass + '"><div class="alert-icon"><i class="fas ' + alertIcon + '"></i></div><div class="alert-content"><h4>' + alert.building + ' - High Consumption</h4><p><strong>' + alert.power.toFixed(2) + ' kW</strong> at ' + alert.timestamp + '</p>' + costImpact + '</div></div>';
            });
        } catch(err) {
            document.getElementById('alerts-list').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Error</h3><p>Please refresh</p></div>';
        }
    }
    
    loadAlerts();
    setInterval(loadAlerts, 5000);
</script>
{% endblock %}
